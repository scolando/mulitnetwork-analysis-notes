<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sara Colando">
<meta name="dcterms.date" content="2025-08-15">

<title>Hierarchical ERGM Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="hierarchical-ergm-writeup_files/libs/clipboard/clipboard.min.js"></script>
<script src="hierarchical-ergm-writeup_files/libs/quarto-html/quarto.js"></script>
<script src="hierarchical-ergm-writeup_files/libs/quarto-html/popper.min.js"></script>
<script src="hierarchical-ergm-writeup_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hierarchical-ergm-writeup_files/libs/quarto-html/anchor.min.js"></script>
<link href="hierarchical-ergm-writeup_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hierarchical-ergm-writeup_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hierarchical-ergm-writeup_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hierarchical-ergm-writeup_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hierarchical-ergm-writeup_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview-of-multi-network-analyses" id="toc-overview-of-multi-network-analyses" class="nav-link active" data-scroll-target="#overview-of-multi-network-analyses"><span class="header-section-number">1</span> Overview of Multi-Network Analyses</a></li>
  <li><a href="#same-but-different-a-comparison-of-estimation-approaches-for-exponential-random-graph-models-for-multiple-networks" id="toc-same-but-different-a-comparison-of-estimation-approaches-for-exponential-random-graph-models-for-multiple-networks" class="nav-link" data-scroll-target="#same-but-different-a-comparison-of-estimation-approaches-for-exponential-random-graph-models-for-multiple-networks"><span class="header-section-number">2</span> Same but different: A comparison of estimation approaches for exponential random graph models for multiple networks</a>
  <ul class="collapse">
  <li><a href="#their-analysis" id="toc-their-analysis" class="nav-link" data-scroll-target="#their-analysis"><span class="header-section-number">2.1</span> Their Analysis</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">2.2</span> Conclusions</a></li>
  <li><a href="#implementations" id="toc-implementations" class="nav-link" data-scroll-target="#implementations"><span class="header-section-number">2.3</span> Implementations</a></li>
  </ul></li>
  <li><a href="#a-bayesian-multilevel-model-for-populations-of-networks-using-exponential-family-random-graphs" id="toc-a-bayesian-multilevel-model-for-populations-of-networks-using-exponential-family-random-graphs" class="nav-link" data-scroll-target="#a-bayesian-multilevel-model-for-populations-of-networks-using-exponential-family-random-graphs"><span class="header-section-number">3</span> A Bayesian multilevel model for populations of networks using exponential-family random graphs</a>
  <ul class="collapse">
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">3.1</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#vignette-example" id="toc-vignette-example" class="nav-link" data-scroll-target="#vignette-example"><span class="header-section-number">3.1.1</span> Vignette Example</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-scalable-exponential-random-graph-model-amortised-hierarchical-sequential-neural-posterior-estimation-with-applications-in-neuroscience" id="toc-a-scalable-exponential-random-graph-model-amortised-hierarchical-sequential-neural-posterior-estimation-with-applications-in-neuroscience" class="nav-link" data-scroll-target="#a-scalable-exponential-random-graph-model-amortised-hierarchical-sequential-neural-posterior-estimation-with-applications-in-neuroscience"><span class="header-section-number">4</span> A Scalable Exponential Random Graph Model: Amortised Hierarchical Sequential Neural Posterior Estimation with Applications in Neuroscience</a></li>
  <li><a href="#my-current-thoughts" id="toc-my-current-thoughts" class="nav-link" data-scroll-target="#my-current-thoughts"><span class="header-section-number">5</span> My Current Thoughts</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">6</span> References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hierarchical ERGM Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sara Colando </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview-of-multi-network-analyses" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview of Multi-Network Analyses</h1>
<p><span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span> define multilevel approach to network analysis as characterized by the following “dependency assumptions”:</p>
<blockquote class="blockquote">
<p>A set of <span class="math inline">\(N\)</span> nodes (e.g., people) broken down into <span class="math inline">\(K\)</span> separate blocks (e.g., classes) such that edges <span class="math inline">\(E\)</span> within a block are <span class="math inline">\(A_k\)</span> are structurally dependent on each other. The nodes <span class="math inline">\(N\)</span> are independent across the <span class="math inline">\(K\)</span> blocks (i.e., no structural possibility for nodes from different blocks to have a tie). Finally, the edges <span class="math inline">\(E\)</span> have an “informational dependency” across blocks <span class="math inline">\(K\)</span> in the sense that they are formed according to a similar dependency structure (e.g., reciprocity, transitivity, etc.). In other words, different blocks have a similar data generating processes behind the tie formation. Therefore, knowing somehting about the structure properties of block <span class="math inline">\(A_i\)</span> may inform the generation of ties in block <span class="math inline">\(A_j\)</span> (pg. 2).</p>
</blockquote>
<p>For our data, we assume this multilevel approach. Specifically, in each classroom, we want to model the conditional probability of an avoidance tie from student <span class="math inline">\(i\)</span> to classmate <span class="math inline">\(j\)</span>. The avoidance edges within each classroom are structurally dependent on each other and the students are independent across classrooms. However, we assume that the share a dependent structure, or in other words, have a similar data generating process (though the exact coefficient values, we do not assume are shared).</p>
</section>
<section id="same-but-different-a-comparison-of-estimation-approaches-for-exponential-random-graph-models-for-multiple-networks" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Same but different: A comparison of estimation approaches for exponential random graph models for multiple networks</h1>
<p><span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span> outline two methods for estimating multiple networks:</p>
<ol type="1">
<li><p>A meta-analytic or <em>hierarchical</em> approach. The entire population is estimated as a single “super-network”, with structural zeros imposed such that actors from different subpopulations cannot interact with each other (an example of this is a a block diagonal approach).</p></li>
<li><p>An <em>integrated</em> approach. A two-step regression approach in which individual enetwork statistics are estimated in the first step and then coefficients are pooled relative to the “grand mean” in the second step. The meta-analysis can estimate the variance in he structural characteristics between different networks via a mixed effects model in the second step. For example, <span class="citation" data-cites="Lubbers2003">Lubbers (<a href="#ref-Lubbers2003" role="doc-biblioref">2003</a>)</span> and <span class="citation" data-cites="Lubbers2007">Lubbers &amp; Snijders (<a href="#ref-Lubbers2007" role="doc-biblioref">2007</a>)</span> proposed:</p></li>
</ol>
<p><span class="math display">\[
\hat{\theta}_m = \mu_\theta + U_m + E_m
\]</span> Here, <span class="math inline">\(\hat{\theta}_m\)</span> is the estimated parameter for network <span class="math inline">\(m\)</span>, <span class="math inline">\(\mu_\theta\)</span> is the average coefficient, <span class="math inline">\(U_m\)</span> is the deviation in network <span class="math inline">\(m\)</span> from this grand mean with <span class="math inline">\(U_m \sim \mathcal{N}(0, \sigma^2_\theta)\)</span>, and <span class="math inline">\(E_m\)</span> is the estimation error.</p>
<p>For both the <em>hierarchical</em> and <em>integrated</em> approaches, no pooling, partial pooling, or complete pooling approaches can be used.</p>
<ul>
<li><em>Complete pooling</em> entails that all networks are assumed to be generated by the same data generating process.</li>
<li><em>No pooling</em> entails that all networks are assumed to be generated by independent data generating processes.</li>
<li><em>Partial pooling</em> entails combining all available information from individual networks and the clusters these networks are in.</li>
</ul>
<p>According to <span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span>, <em>partial pooling</em> is almost always the preferred method when dealing with clustered data.</p>
<p>Both the <em>hierarchical</em> and <em>integrated</em> method for multiple network analyses can implement a partial pooling approach <span class="citation" data-cites="Tolochko2024">(<a href="#ref-Tolochko2024" role="doc-biblioref">Tolochko &amp; Boomgaarden, 2024</a>)</span>.</p>
<ul>
<li><p>For the <em>hierarchical</em> approach: use a Bayesian hierarchical model for the two-step regression. <strong>Partial pooling in the hierarchical approach can be done using the <code>ergm</code> package with the <code>Stan</code> statistical modeling language and the <code>brms</code> package.</strong></p></li>
<li><p>For the <em>integrated</em> approach: model the local and global dependence simultaneously. <strong>Partial pooling in the integrated approach can be done using the <code>mlergm</code> package</strong></p></li>
</ul>
<section id="their-analysis" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="their-analysis"><span class="header-section-number">2.1</span> Their Analysis</h2>
<p><span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span> evaluate the (relative) performance of the two methods through an empirical case study and an simulated case study using the software mentioned in the section above.</p>
<p><strong>Empirical Case Study (Study 1):</strong> 121 networks (school classes), nested in 15 different schools, across three different countries (Germany, Italy, and Portugal). Importantly, this dataset is quite unique because it has several hierarchical levels (classes, schools, and countries), allowing us to compare how partial pooling of estimates works on multiple clustering levels <span class="citation" data-cites="Tolochko2024">(<a href="#ref-Tolochko2024" role="doc-biblioref">Tolochko &amp; Boomgaarden, 2024</a>)</span>.</p>
<p><strong>Simulated Case Study (Study 2):</strong> Let <span class="math inline">\(\theta_{ij}\)</span> denote the <span class="math inline">\(i\)</span>th network coefficient for group <span class="math inline">\(j\)</span>, <span class="math inline">\(\mu\)</span> denote the “grand mean” of the coefficient, <span class="math inline">\(\Delta_j\)</span> denote the group effects, and <span class="math inline">\(\delta_j\)</span> denote the variance of the group effect for group <span class="math inline">\(j\)</span>. The model for the input parameters of the Monte Carlo simulation is the following:</p>
<p><span class="math display">\[
\begin{align}
\theta_{ij} &amp;= \mu_i + \Delta_j \\
\Delta_i &amp;\sim \mathcal{N}(0, \delta_j)
\end{align}
\]</span></p>
<p>The realized <span class="math inline">\(\theta\)</span> coefficients are then fed into the ERGM simulation algorithm to simulate random networks <span class="citation" data-cites="Tolochko2024">(<a href="#ref-Tolochko2024" role="doc-biblioref">Tolochko &amp; Boomgaarden, 2024</a>)</span>. They vary the input parameters (number of groups, group size, nodes per network, and group effect size). See Table 1 for a summary of the variations in the input parameters.</p>
</section>
<section id="conclusions" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="conclusions"><span class="header-section-number">2.2</span> Conclusions</h2>
<p>Given the ground truth is only known in the simulated case study (Study 2), I just report these results. Specifically, they looked at the absolute error and predicted MAE for three approaches: <strong>(1)</strong> Hierarchical (no group), <strong>(2)</strong> Hierarchical (group), and <strong>(3)</strong> Integrated. The results are shown in Figure 6 and Table 2.</p>
<p><span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span> find that the hierarchical regression model (with errors clustered on the group level) was most accurate, with the smallest mean absolute error across all conditions (pg. 8). The hierarchical model with no grouping was a close second (pg. 8), and the integrated approach was least accurate, with the largest mean absolute error across all conditions (pg. 9).</p>
<p>Group effect size and number of groups were the simulation factors with the largest influence on the absolute error. The number of networks and size of networks decreased the absolute error <span class="citation" data-cites="Tolochko2024">(<a href="#ref-Tolochko2024" role="doc-biblioref">Tolochko &amp; Boomgaarden, 2024</a>)</span>.</p>
</section>
<section id="implementations" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="implementations"><span class="header-section-number">2.3</span> Implementations</h2>
<p>The first author has created a <code>ERGMeta</code> package based on the paper <span class="citation" data-cites="Tolochko2024">(<a href="#ref-Tolochko2024" role="doc-biblioref">Tolochko &amp; Boomgaarden, 2024</a>)</span>. Here is the <a href="https://github.com/PeterTolochko/ERGMeta">GitHub Repository for the <code>ERGMeta</code> package</a>. Overall, it looks relatively straight forward to implement.</p>
<p><span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span> also include several references to other papers which use hierarchical meta-analysis approaches on network data. Listed below are some which also include their implementation code:</p>
<ul>
<li><p><span class="citation" data-cites="Minozzi2019">Minozzi et al. (<a href="#ref-Minozzi2019" role="doc-biblioref">2019</a>)</span>; <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VSVBTP">replication code</a></p></li>
<li><p><span class="citation" data-cites="Rver2020">Röver (<a href="#ref-Rver2020" role="doc-biblioref">2020</a>)</span>; <a href="https://cran.r-project.org/web/packages/bayesmeta/index.html"><code>bayesmeta</code> package</a></p></li>
</ul>
</section>
</section>
<section id="a-bayesian-multilevel-model-for-populations-of-networks-using-exponential-family-random-graphs" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> A Bayesian multilevel model for populations of networks using exponential-family random graphs</h1>
<p><span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span> describe a model for when the outcome of interest is a network-valued random variable whose distribution is given by an exponential random graph model. Their method is a Bayesian hierarchical model than can be used to model a “population” of networks. They formalize their Bayesian hierarchical ERGM model as follows:</p>
<p>Let <span class="math inline">\(\mathbf{Y} = \left(\mathbf{Y}^{(1)}, \dots, \mathbf{Y}^{(n)} \right)\)</span> be a set of <span class="math inline">\(n\)</span> networks and let <span class="math inline">\(X \in \mathbb{R}^{n \times q}\)</span> be a matrix of <span class="math inline">\(q\)</span> network-level covariates. Identify each network <span class="math inline">\(\mathbf{Y}^{(i)}\)</span> with its own vector-valued ERGM parameter <span class="math inline">\(\theta^{(i)}\)</span> and let <span class="math inline">\(\mathbf{\theta} = \left(\theta^{(1)}, \dots, \theta^{(n)} \right)\)</span> be the set of network-level parameters. The observed network <span class="math inline">\(\mathbf{y}\)</span> is assumed to follow an ERGM conditional of the covariates and vector-valued parameter vector:</p>
<p><span id="eq-ergm-formula"><span class="math display">\[
\pi(\mathbf{y} \mid \mathbf{x}, \theta) = \frac{\exp\left \{ \eta(\theta)^T s(\mathbf{y}, \mathbf{x}) \right \}}{Z(\theta)}
\tag{1}\]</span></span></p>
<p>For each network, <span class="math inline">\(\mathbf{Y}^{(i)} \sim \pi(\cdot \mid \theta^{(i)})\)</span>. Note too that each ERGM must consist of the same set of <span class="math inline">\(p\)</span> summary statistics <span class="math inline">\(s(\cdot)\)</span>. <span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span> then propose the following multilevel model (see <a href="#fig-multibergm-diagram" class="quarto-xref">Figure&nbsp;1</a>):</p>
<p><span id="eq-multibergm-formulation"><span class="math display">\[
\begin{aligned}
&amp;\mathbf{Y}^{(i)} \sim \pi \left(\cdot \mid \theta^{(i)} \right), \quad i = 1, \dots, n \\
&amp;\theta^{(i)} \sim \mathcal{N}\left(x_i^T \beta, \Sigma_\epsilon \right), \quad i = 1, \dots, n
\end{aligned}
\tag{2}\]</span></span></p>
<p>In <a href="#eq-multibergm-formulation" class="quarto-xref">Equation&nbsp;2</a>, <span class="math inline">\(\beta\)</span> is a <span class="math inline">\(q \times p\)</span> matrix of parameters and <span class="math inline">\(x_i\)</span> is a vector of length <span class="math inline">\(q\)</span> that corresponds to the <span class="math inline">\(i\)</span>th column of <span class="math inline">\(X\)</span>. There is an assumption that, conditional on their respective network-level parameters <span class="math inline">\(\theta^{(i)}\)</span>, the <span class="math inline">\(\mathbf{Y}^{(i)}\)</span> are independent. Thus, the sampling distribution for the set of networks <span class="math inline">\(\pmb{Y}\)</span> is simply the product of the individual probability mass functions:</p>
<p><span id="eq-prod-pmfs"><span class="math display">\[
\begin{aligned}
\pi(\pmb{y}|\pmb{\theta}) &amp;= \prod_{i=1}^n \pi(\pmb{y}^{(i)}|\theta^{(i)}) \\
&amp; = \dfrac{\exp\left\lbrace\sum_{i=1}^n \theta^{(i)T}s(\pmb{y}^{(i)}) \right\rbrace}{\prod_{i=1}^n Z(\theta^{(i)})}.
\end{aligned}
\tag{3}\]</span></span></p>
<div id="fig-multibergm-diagram" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-multibergm-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="vignettes/diagram.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-multibergm-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: <code>multibergm</code> Diagram
</figcaption>
</figure>
</div>
<section id="implementation" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="implementation"><span class="header-section-number">3.1</span> Implementation</h2>
<p><span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span> implement their Bayesian hierarchical ERGM via the <code>multibergm</code> package, which takes care of the “exchange-within-Gibbs MCMC algorithm” they implement to generate samples from the doubly-intractable posterior distribution. This package claims to be built on and inspired by the <strong>ergm</strong> R package and uses the same syntax to specify models.</p>
<p><strong>Note:</strong> I had to do some manual editing of functions and install an old version of R to use <code>ergm 3.11.0</code> in order to get the functions in this package to run.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#devtools::install_github("brieuclehmann/multibergm")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#packageurl &lt;- "https://cran.r-project.org/src/contrib/Archive/ergm/ergm_3.11.0.tar.gz"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(packageurl, repos = NULL, type = "source")</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multibergm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="vignette-example" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="vignette-example"><span class="header-section-number">3.1.1</span> Vignette Example</h3>
<p>The <code>multibergm</code> vignette uses data from David Krackhardt’s study on cognitive social structures <span class="citation" data-cites="Krackhardt1987">(<a href="#ref-Krackhardt1987" role="doc-biblioref">Krackhardt, 1987</a>)</span>. The dataset consists of a set of friendship networks between 21 managers of a high-tech firm. There are 21 friendship networks, each corresponding to the perceived network of one of the managers. There is also a single network with edges corresponding to self-identified friendships among the 21 managers.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-manager-sample" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-manager-sample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-ergm-writeup_files/figure-html/fig-manager-sample-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-manager-sample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Sample of manager networks.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="fitting-and-analyzing-a-multi-network-ergm" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1" class="anchored" data-anchor-id="fitting-and-analyzing-a-multi-network-ergm"><span class="header-section-number">3.1.1.1</span> Fitting and analyzing a multi-network ERGM</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">multibergm</span>(krackfr<span class="sc">$</span>networks <span class="sc">~</span> edges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'R/plot.multibergm.R'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'R/summary.multibergm.R'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hierarchical-ergm-writeup_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">burn_in =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hierarchical-ergm-writeup_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1, <span class="at">burn_in =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Posterior Density Estimate for Model: 
y ~ edges 
 
                      [,1]   [,2]    [,3]     [,4]
mu_(Intercept)_edges -2.55 0.1946 0.00688 0.007846

                       [,1]   [,2]   [,3]   [,4]   [,5]
mu_(Intercept)_edges -2.941 -2.685 -2.545 -2.415 -2.189

 Theta acceptance rate: 
0.411 (0.385, 0.452)
 Mu acceptance rate: 
0.385 (0.385, 0.385) </code></pre>
</div>
</div>
<p>In order, the summary output shows the posterior mean, standard deviation, naive standard error, time-series standard error, and quantiles of each of the parameters in the model (2.5%, 25%, 50%, 75%,97.5%) for the edges parameter. The summary output also provides the acceptance rates for the individual-level (theta) and group-level (mu) parameters - more on this below.</p>
<p>The default (hyper)priors on the group-level parameters <span class="math inline">\((\mu, \Sigma_\theta)\)</span> are: <span class="math display">\[
\begin{align}
\mu &amp;\sim \mathcal{N}(0, 100I) \\
\Sigma_\theta &amp;\sim \mathcal{W}^{-1}(p+1,~I)
\end{align}
\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the number of summary statistics in the model and <span class="math inline">\(\mathcal{W}^{-1}\)</span> denotes an inverse-Wishart distribution. These can be manually specified using the <code>set_priors</code> function in the <code>multibergm</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(fit1<span class="sc">$</span>params<span class="sc">$</span>theta[<span class="dv">1</span>, <span class="dv">200</span><span class="sc">:</span><span class="dv">1000</span>, , <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">'network'</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">'edges_posterior'</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">network =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(network, <span class="at">start =</span> <span class="dv">2</span>))))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> edges_posterior))<span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">color =</span> network, <span class="at">fill =</span> network), <span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(edges_posterior)))<span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(<span class="fu">coef</span>(fit1<span class="sc">$</span>params<span class="sc">$</span>mu)[<span class="dv">1</span>,<span class="dv">2</span>])),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">linetype =</span> <span class="st">'dashed'</span>)<span class="sc">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">'Density'</span>, <span class="at">x =</span> <span class="st">'Edges coefficeint posterior draws'</span>,,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">'Manager Network'</span>, <span class="at">fill =</span> <span class="st">'Manager Network'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hierarchical-ergm-writeup_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>edges_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.003634756</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ERGM coefficients estimates</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>single_fits  <span class="ot">&lt;-</span> <span class="fu">lapply</span>(krackfr<span class="sc">$</span>networks, <span class="cf">function</span>(x) <span class="fu">ergm</span>(x <span class="sc">~</span> edges))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>single_coefs <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">sapply</span>(single_fits, coef))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(fit1<span class="sc">$</span>params) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(term, estimate) <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">'^theta</span><span class="sc">\\</span><span class="st">['</span>,term)) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fixed_effect =</span> <span class="sc">-</span><span class="fl">2.519</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">coef =</span> fixed_effect <span class="sc">+</span> estimate) <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(single_coefs) <span class="sc">|&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff_coef =</span> single_coefs <span class="sc">-</span> coef) <span class="sc">|&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 12%">
<col style="width: 17%">
<col style="width: 9%">
<col style="width: 17%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">fixed_effect</th>
<th style="text-align: right;">coef</th>
<th style="text-align: right;">single_coefs</th>
<th style="text-align: right;">diff_coef</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">edges</td>
<td style="text-align: left;">theta[1,1]</td>
<td style="text-align: right;">0.721</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-1.798</td>
<td style="text-align: right;">-1.792</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.1</td>
<td style="text-align: left;">theta[2,1]</td>
<td style="text-align: right;">-0.372</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.891</td>
<td style="text-align: right;">-2.944</td>
<td style="text-align: right;">-0.053</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.2</td>
<td style="text-align: left;">theta[3,1]</td>
<td style="text-align: right;">-1.334</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-3.853</td>
<td style="text-align: right;">-4.078</td>
<td style="text-align: right;">-0.224</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.3</td>
<td style="text-align: left;">theta[4,1]</td>
<td style="text-align: right;">0.160</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.359</td>
<td style="text-align: right;">-2.367</td>
<td style="text-align: right;">-0.008</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.4</td>
<td style="text-align: left;">theta[5,1]</td>
<td style="text-align: right;">0.875</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-1.644</td>
<td style="text-align: right;">-1.627</td>
<td style="text-align: right;">0.018</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.5</td>
<td style="text-align: left;">theta[6,1]</td>
<td style="text-align: right;">-0.078</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.597</td>
<td style="text-align: right;">-2.601</td>
<td style="text-align: right;">-0.004</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.6</td>
<td style="text-align: left;">theta[7,1]</td>
<td style="text-align: right;">1.027</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-1.492</td>
<td style="text-align: right;">-1.478</td>
<td style="text-align: right;">0.014</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.7</td>
<td style="text-align: left;">theta[8,1]</td>
<td style="text-align: right;">-1.501</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-4.020</td>
<td style="text-align: right;">-4.419</td>
<td style="text-align: right;">-0.399</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.8</td>
<td style="text-align: left;">theta[9,1]</td>
<td style="text-align: right;">-1.391</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-3.910</td>
<td style="text-align: right;">-4.234</td>
<td style="text-align: right;">-0.324</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.9</td>
<td style="text-align: left;">theta[10,1]</td>
<td style="text-align: right;">0.388</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.131</td>
<td style="text-align: right;">-2.120</td>
<td style="text-align: right;">0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.10</td>
<td style="text-align: left;">theta[11,1]</td>
<td style="text-align: right;">0.898</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-1.621</td>
<td style="text-align: right;">-1.592</td>
<td style="text-align: right;">0.028</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.11</td>
<td style="text-align: left;">theta[12,1]</td>
<td style="text-align: right;">-0.149</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.668</td>
<td style="text-align: right;">-2.678</td>
<td style="text-align: right;">-0.010</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.12</td>
<td style="text-align: left;">theta[13,1]</td>
<td style="text-align: right;">0.112</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.407</td>
<td style="text-align: right;">-2.462</td>
<td style="text-align: right;">-0.055</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.13</td>
<td style="text-align: left;">theta[14,1]</td>
<td style="text-align: right;">0.486</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.033</td>
<td style="text-align: right;">-2.048</td>
<td style="text-align: right;">-0.014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.14</td>
<td style="text-align: left;">theta[15,1]</td>
<td style="text-align: right;">0.116</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.403</td>
<td style="text-align: right;">-2.429</td>
<td style="text-align: right;">-0.027</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.15</td>
<td style="text-align: left;">theta[16,1]</td>
<td style="text-align: right;">-0.173</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.692</td>
<td style="text-align: right;">-2.760</td>
<td style="text-align: right;">-0.068</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.16</td>
<td style="text-align: left;">theta[17,1]</td>
<td style="text-align: right;">0.298</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.221</td>
<td style="text-align: right;">-2.224</td>
<td style="text-align: right;">-0.003</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.17</td>
<td style="text-align: left;">theta[18,1]</td>
<td style="text-align: right;">-0.359</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.878</td>
<td style="text-align: right;">-2.944</td>
<td style="text-align: right;">-0.066</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.18</td>
<td style="text-align: left;">theta[19,1]</td>
<td style="text-align: right;">0.968</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-1.551</td>
<td style="text-align: right;">-1.542</td>
<td style="text-align: right;">0.009</td>
</tr>
<tr class="even">
<td style="text-align: left;">edges.19</td>
<td style="text-align: left;">theta[20,1]</td>
<td style="text-align: right;">-1.051</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-3.570</td>
<td style="text-align: right;">-3.714</td>
<td style="text-align: right;">-0.144</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edges.20</td>
<td style="text-align: left;">theta[21,1]</td>
<td style="text-align: right;">0.504</td>
<td style="text-align: right;">-2.519</td>
<td style="text-align: right;">-2.015</td>
<td style="text-align: right;">-2.001</td>
<td style="text-align: right;">0.014</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="goodness-of-fit" class="level4" data-number="3.1.1.2">
<h4 data-number="3.1.1.2" class="anchored" data-anchor-id="goodness-of-fit"><span class="header-section-number">3.1.1.2</span> Goodness of fit</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'R/gof.multibergm.R'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plyr)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(statnet.common)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">gof</span>(fit1, <span class="at">burn_in =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hierarchical-ergm-writeup_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>init<span class="sc">$</span>mu_pop    <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(single_coefs) <span class="co">#initializing with individual ERGM est. </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>init<span class="sc">$</span>theta     <span class="ot">&lt;-</span> <span class="fu">sweep</span>(single_coefs, <span class="dv">1</span>, init<span class="sc">$</span>mu_pop)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>init<span class="sc">$</span>cov_theta <span class="ot">&lt;-</span> <span class="fu">cov</span>(init<span class="sc">$</span>theta)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>init<span class="sc">$</span>mu <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">colMeans</span>(single_coefs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="second-vignette-example-with-specified-initial-values" class="level4" data-number="3.1.1.3">
<h4 data-number="3.1.1.3" class="anchored" data-anchor-id="second-vignette-example-with-specified-initial-values"><span class="header-section-number">3.1.1.3</span> Second vignette example with specified initial values</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">multibergm</span>(krackfr<span class="sc">$</span>networks <span class="sc">~</span> edges, <span class="at">init =</span> init)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gof</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hierarchical-ergm-writeup_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="a-scalable-exponential-random-graph-model-amortised-hierarchical-sequential-neural-posterior-estimation-with-applications-in-neuroscience" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> A Scalable Exponential Random Graph Model: Amortised Hierarchical Sequential Neural Posterior Estimation with Applications in Neuroscience</h1>
<p><strong>Note:</strong> I did not spend a lot of time with this paper given it does not include code for implementing their method (only algorithm outlines throughout the paper). In turn, I just summarize the article’s claimed contributions and main findings.</p>
<p><span class="citation" data-cites="Fan2025">Fan &amp; White (<a href="#ref-Fan2025" role="doc-biblioref">2025</a>)</span> propose an “Amortised Hierarchical Sequential Neural Posterior Estimation” (AHS-NPE) approach to jointly model a group or population of networks using a hierarchical Bayesian setup, which effectively lowers the computational demand for increasing the number of network samples in a multi-network hierarchical ERGM framework.</p>
<ul>
<li><em>Neural Posterior Estimation</em> (NPE) is a likelihood-free approach where a neural network-based conditional estimator is trained to infer the Bayesian posterior distribution <span class="citation" data-cites="Fan2025">(<a href="#ref-Fan2025" role="doc-biblioref">Fan &amp; White, 2025</a>)</span>. NPE has shown better <em>amortisation</em> (which focuses on the cost of re-fitting the model upon inference on a new observation and thus is related to computational efficiency).</li>
</ul>
<p>Specifically, <span class="citation" data-cites="Fan2025">Fan &amp; White (<a href="#ref-Fan2025" role="doc-biblioref">2025</a>)</span> use NPE to estimate “local parameters for individual networks and use an analytically tractable variational approximation scheme for the hierarchical parameters”. Further, the EM algorithm is used to iteratively train, refine and adjust the normalizing flow-based estimator and training data <span class="citation" data-cites="Fan2025">(<a href="#ref-Fan2025" role="doc-biblioref">Fan &amp; White, 2025</a>)</span>. More information on the estimation scheme is given in Algorithm 1, 2, and 3.</p>
<p><span class="citation" data-cites="Fan2025">Fan &amp; White (<a href="#ref-Fan2025" role="doc-biblioref">2025</a>)</span> compare their model to the hierarchical Bayesian ERGM approach from <span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span>. First, they reproduce the results from the empirical fMRI Cam-CAN data <span class="citation" data-cites="Lehmann2024">(<a href="#ref-Lehmann2024" role="doc-biblioref">Lehmann &amp; White, 2024</a>)</span>. Like <span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span>, each individual network is assumed to follow a ERGM.</p>
<ul>
<li><p>“Overall, AHS-NPE demonstrates accurate estimation and consistency with conventional Bayesian fittings, aligning closely with both our Bayesian fitting and <span class="citation" data-cites="Lehmann2024">Lehmann &amp; White (<a href="#ref-Lehmann2024" role="doc-biblioref">2024</a>)</span>’s fitting”. Thus, <span class="citation" data-cites="Fan2025">Fan &amp; White (<a href="#ref-Fan2025" role="doc-biblioref">2025</a>)</span> conclude their method (AHS-NPE) is a “reliable tool for network analysis studies”</p></li>
<li><p>Per <span class="citation" data-cites="Fan2025">Fan &amp; White (<a href="#ref-Fan2025" role="doc-biblioref">2025</a>)</span>, AHS-NPE is also “a much scalable modelling framework, which proves to be essential for the developed MN-ERGMs.” Indeed, the computational demand for conditional density estimation are approximately the same between the implementation on 100 and 256 network samples (per group) since <em>amortisation</em> means once the model is trained, the inference step is negligible <span class="citation" data-cites="Fan2025">(<a href="#ref-Fan2025" role="doc-biblioref">Fan &amp; White, 2025</a>)</span>.</p></li>
</ul>
</section>
<section id="my-current-thoughts" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> My Current Thoughts</h1>
<ul>
<li><p>Based on what I could find, it seems like if we want to do a something similar to a traditional “mixed effects” approach from regression and not write the estimation algorithm from scratch, our best bet would be to use the <code>mulitbergm</code> package in order to obtain network-level random effects. However, this package has not been updated in at least a year and hasn’t been used by that many others (based on Google scholar citations).</p></li>
<li><p>That said, there seems to be evidence towards using a two-step modeling hierarchical Bayesian (or mixed effects) approach to partially pool across multiple networks (e.g., based on <span class="citation" data-cites="Tolochko2024">Tolochko &amp; Boomgaarden (<a href="#ref-Tolochko2024" role="doc-biblioref">2024</a>)</span>). The downside, though, of these approach is we would have to cull the number of covariates we have in our ERGM since our class networks might be only 15 students or so. I am also unclear how (or whether) the two-step modeling approach accounts for the two levels of statistical uncertainty.</p></li>
</ul>
<p><strong>Note:</strong> I don’t think these papers are super relevant (I found them when trying to find methods for modeling populations of networks with ERGMs where there are network-level random effects). However, just in case they are helpful in some way (e.g., maybe doing an “integrative approach” but with group-level random effect on <code>classid</code>):</p>
<ul>
<li><p><a href="https://www.sciencedirect.com/science/article/pii/S0378873316000034">ERGMs with nodal-level random effects</a></p></li>
<li><p><a href="https://polisci.osu.edu/sites/default/files/2019-12/Social_Networks_2019.pdf">ERGMs with individual (or group) level random effects</a></p></li>
</ul>
</section>
<section id="references" class="level1 unnumbered" data-number="6">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">6 References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Fan2025" class="csl-entry" role="listitem">
Fan, Y., &amp; White, S. R. (2025). <em>A scalable exponential random graph model: Amortised hierarchical sequential neural posterior estimation with applications in neuroscience</em>. arXiv. <a href="https://doi.org/10.48550/ARXIV.2506.04558">https://doi.org/10.48550/ARXIV.2506.04558</a>
</div>
<div id="ref-Krackhardt1987" class="csl-entry" role="listitem">
Krackhardt, D. (1987). Cognitive social structures. <em>Social Networks</em>, <em>9</em>(2), 109–134. <a href="https://doi.org/10.1016/0378-8733(87)90009-8">https://doi.org/10.1016/0378-8733(87)90009-8</a>
</div>
<div id="ref-Lehmann2024" class="csl-entry" role="listitem">
Lehmann, B., &amp; White, S. (2024). A bayesian multilevel model for populations of networks using exponential-family random graphs. <em>Statistics and Computing</em>, <em>34</em>(4). <a href="https://doi.org/10.1007/s11222-024-10446-0">https://doi.org/10.1007/s11222-024-10446-0</a>
</div>
<div id="ref-Lubbers2003" class="csl-entry" role="listitem">
Lubbers, M. J. (2003). Group composition and network structure in school classes: A multilevel application of the p∗ model. <em>Social Networks</em>, <em>25</em>(4), 309–332. <a href="https://doi.org/10.1016/s0378-8733(03)00013-3">https://doi.org/10.1016/s0378-8733(03)00013-3</a>
</div>
<div id="ref-Lubbers2007" class="csl-entry" role="listitem">
Lubbers, M. J., &amp; Snijders, T. A. B. (2007). A comparison of various approaches to the exponential random graph model: A reanalysis of 102 student networks in school classes. <em>Social Networks</em>, <em>29</em>(4), 489–507. <a href="https://doi.org/10.1016/j.socnet.2007.03.002">https://doi.org/10.1016/j.socnet.2007.03.002</a>
</div>
<div id="ref-Minozzi2019" class="csl-entry" role="listitem">
Minozzi, W., Song, H., Lazer, D. M. J., Neblo, M. A., &amp; Ognyanova, K. (2019). The incidental pundit: Who talks politics with whom, and why? <em>American Journal of Political Science</em>, <em>64</em>(1), 135–151. <a href="https://doi.org/10.1111/ajps.12469">https://doi.org/10.1111/ajps.12469</a>
</div>
<div id="ref-Rver2020" class="csl-entry" role="listitem">
Röver, C. (2020). Bayesian random-effects meta-analysis using the bayesmeta r package. <em>Journal of Statistical Software</em>, <em>93</em>(6). <a href="https://doi.org/10.18637/jss.v093.i06">https://doi.org/10.18637/jss.v093.i06</a>
</div>
<div id="ref-Tolochko2024" class="csl-entry" role="listitem">
Tolochko, P., &amp; Boomgaarden, H. G. (2024). Same but different: A comparison of estimation approaches for exponential random graph models for multiple networks. <em>Social Networks</em>, <em>76</em>, 1–11. <a href="https://doi.org/10.1016/j.socnet.2023.05.003">https://doi.org/10.1016/j.socnet.2023.05.003</a>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>